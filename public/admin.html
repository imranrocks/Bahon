<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bahon Nexus | Master Admin OS</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap');
        
        :root { --p: #6366f1; --p-glow: rgba(99, 102, 241, 0.4); }
        body.theme-dark { --bg: #0f172a; --card: #1e293b; --side: #0f172a; --text: #f1f5f9; --border: rgba(255,255,255,0.06); }
        body.theme-amoled { --bg: #000000; --card: #0a0a0a; --side: #000000; --text: #ffffff; --border: #1a1a1a; }
        body.theme-light { --bg: #f8fafc; --card: #ffffff; --side: #ffffff; --text: #1e293b; --border: #e2e8f0; }

        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); color: var(--text); overflow: hidden; transition: 0.3s; }
        .sidebar { background: var(--side); border-right: 1px solid var(--border); overflow-y: auto; }
        .nav-btn { color: #94a3b8; transition: 0.2s; font-weight: 700; display: flex; align-items: center; gap: 14px; width: 100%; padding: 14px 24px; border-radius: 18px; margin-bottom: 6px; font-size: 13px; cursor: pointer; border:none; background:none; text-align: left; }
        .nav-btn:hover { background: rgba(99, 102, 241, 0.05); color: var(--p); }
        .nav-btn.active { color: #fff; background: var(--p); box-shadow: 0 10px 25px -5px var(--p-glow); }
        
        .card { background: var(--card); border: 1px solid var(--border); border-radius: 30px; }
        .glass-header { background: rgba(255,255,255,0.01); backdrop-filter: blur(20px); border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 50; }
        
        .nexus-table { width: 100%; border-collapse: separate; border-spacing: 0; }
        .nexus-table th { padding: 20px 24px; font-size: 11px; font-weight: 800; text-transform: uppercase; color: #64748b; border-bottom: 1px solid var(--border); letter-spacing: 1px; }
        .nexus-table td { padding: 18px 24px; border-bottom: 1px solid var(--border); font-size: 14px; }
        
        .modal-bg { background: rgba(0,0,0,0.8); backdrop-filter: blur(8px); position: fixed; inset: 0; z-index: 100; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: var(--border); border-radius: 10px; }
    </style>
</head>
<body class="theme-dark">

    <div id="auth-screen" class="fixed inset-0 z-[1000] bg-black flex items-center justify-center p-6 text-center">
        <div>
            <div class="mb-8 inline-block p-6 rounded-[40px] bg-gradient-to-tr from-indigo-600 to-purple-600 shadow-2xl">
                <i data-lucide="shield-check" class="w-16 h-16 text-white"></i>
            </div>
            <h1 class="text-6xl font-black italic text-white mb-2 tracking-tighter italic">BAHON<span class="text-indigo-500">_NEXUS</span></h1>
            <p class="text-slate-500 mb-10 font-bold uppercase tracking-widest text-[10px]">Version 4.0 Enterprise OS</p>
            <button onclick="App.login()" class="px-12 py-5 bg-white text-black font-black rounded-full hover:scale-105 transition active:scale-95">AUTHENTICATE SYSTEM</button>
        </div>
    </div>

    <div id="app-shell" class="hidden h-screen flex overflow-hidden">
        <aside class="sidebar w-80 flex flex-col p-8 shrink-0">
            <div class="mb-10 px-2 flex items-center gap-3">
                <div class="w-10 h-10 bg-indigo-600 rounded-2xl flex items-center justify-center text-white font-black italic">B</div>
                <h2 class="text-xl font-black italic tracking-tighter italic">NEXUS_OS</h2>
            </div>

            <nav class="flex-1 custom-scroll" id="sidebar-nav"></nav>

            <div class="mt-6 pt-6 border-t border-white/5">
                <div class="flex items-center gap-4 p-4 rounded-2xl bg-white/5 mb-4">
                    <img id="admin-pfp" class="w-10 h-10 rounded-xl bg-slate-800" src="">
                    <div class="truncate">
                        <p id="admin-name" class="text-[11px] font-black truncate text-white"></p>
                        <p onclick="App.logout()" class="text-[9px] font-bold text-red-500 cursor-pointer uppercase mt-1 hover:underline">Terminate Session</p>
                    </div>
                </div>
            </div>
        </aside>

        <main class="flex-1 flex flex-col min-w-0">
            <header class="glass-header px-12 py-8 flex justify-between items-center">
                <div>
                    <h2 id="view-title" class="text-3xl font-black italic tracking-tighter uppercase">Dashboard</h2>
                    <p id="view-desc" class="text-[10px] font-black text-slate-500 uppercase tracking-[3px] mt-1">Intelligence Overview</p>
                </div>
                <div class="flex items-center gap-6">
                    <select onchange="App.setTheme(this.value)" class="bg-white/5 border border-white/10 rounded-xl px-4 py-2 text-[10px] font-black outline-none uppercase">
                        <option value="dark">Dark UI</option>
                        <option value="amoled">Amoled Black</option>
                        <option value="light">Light UI</option>
                    </select>
                    <div class="flex items-center gap-2 px-4 py-2 bg-emerald-500/10 rounded-full border border-emerald-500/20">
                        <span class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></span>
                        <span class="text-[10px] font-black text-emerald-500 uppercase tracking-widest">Live Sync</span>
                    </div>
                </div>
            </header>

            <div id="workspace" class="flex-1 overflow-y-auto p-12 custom-scroll"></div>
        </main>
    </div>

    <div id="modal-root" class="hidden modal-bg">
        <div class="card p-10 max-w-2xl w-full relative shadow-2xl">
            <button onclick="App.closeModal()" class="absolute top-6 right-6 w-10 h-10 rounded-full bg-white/5 hover:bg-white/10 flex items-center justify-center font-bold text-xl">âœ•</button>
            <div id="modal-content"></div>
        </div>
    </div>
    <script>
    const firebaseConfig = {
        apiKey: "AIzaSyCLmMAyjxYUCBK3h8lgSU_1-rIRfdGnJWw",
        authDomain: "bahon-imranlabs.firebaseapp.com",
        projectId: "bahon-imranlabs",
        storageBucket: "bahon-imranlabs.firebasestorage.app",
        messagingSenderId: "957277842201",
        appId: "1:957277842201:android:7866c3022916a166cab388"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    const App = {
        state: {
            activeTab: 'dashboard',
            users: [],
            records: [],
            logs: [],
            admins: [],
            notifications: [],
            config: {},
            authorizedAdmins: ["innocentboyimran0@gmail.com", "hyperff94@gmail.com"]
        },

        login() { auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); },
        logout() { auth.signOut().then(() => location.reload()); },

        init() {
            auth.onAuthStateChanged(user => {
                if (user && this.state.authorizedAdmins.includes(user.email)) {
                    document.getElementById('auth-screen').style.display = 'none';
                    document.getElementById('app-shell').classList.remove('hidden');
                    document.getElementById('admin-name').innerText = user.displayName;
                    document.getElementById('admin-pfp').src = user.photoURL;
                    this.bootstrap();
                } else if(user) { alert("Access Denied: Unrecognized Admin Identity."); auth.signOut(); }
            });
        },

        bootstrap() {
            this.renderNav();
            this.sync('users', 'users');
            this.sync('master_records', 'records', 'createdAt', 'desc');
            this.sync('audit_logs', 'logs', 'timestamp', 'desc');
            this.sync('admins', 'admins');
            this.sync('notifications', 'notifications', 'createdAt', 'desc');
            this.syncDoc('remote_config', 'flags', 'config');
            
            this.navigate('dashboard');
            lucide.createIcons();
        },

        sync(col, key, orderBy = null, dir = 'asc') {
            let ref = db.collection(col);
            if(orderBy) ref = ref.orderBy(orderBy, dir);
            ref.onSnapshot(s => {
                this.state[key] = s.docs.map(d => ({id: d.id, ...d.data()}));
                this.refresh();
            });
        },

        syncDoc(col, doc, key) {
            db.collection(col).doc(doc).onSnapshot(s => {
                this.state[key] = s.data() || {};
                this.refresh();
            });
        },

        navigate(tab) {
            this.state.activeTab = tab;
            document.querySelectorAll('.nav-btn').forEach(b => {
                b.classList.toggle('active', b.dataset.id === tab);
            });
            document.getElementById('view-title').innerText = tab;
            this.refresh();
        },

        refresh() {
            const workspace = document.getElementById('workspace');
            workspace.innerHTML = `<div class="animate-in fade-in slide-in-from-bottom-4 duration-500">${this.renderers[this.state.activeTab]()}</div>`;
            lucide.createIcons();
            if(this.state.activeTab === 'dashboard') this.loadDashChart();
            if(this.state.activeTab === 'analytics') this.loadAnalyticsCharts();
        },

        setTheme(t) { document.body.className = `theme-${t}`; },
        openModal(html) { document.getElementById('modal-content').innerHTML = html; document.getElementById('modal-root').classList.remove('hidden'); lucide.createIcons(); },
        closeModal() { document.getElementById('modal-root').classList.add('hidden'); }
    };

    App.renderNav = function() {
        const menu = [
            {id:'dashboard', icon:'layout-grid', label:'Dashboard'},
            {id:'analytics', icon:'line-chart', label:'Deep Analytics'},
            {id:'records', icon:'database', label:'Master Logs'},
            {id:'users', icon:'users', label:'User Manager'},
            {id:'reports', icon:'file-text', label:'Report Engine'},
            {id:'notifications', icon:'bell', label:'Broadcast'},
            {id:'appcontrol', icon:'sliders', label:'App Engine'},
            {id:'admins', icon:'shield', label:'Admin Core'},
            {id:'logs', icon:'history', label:'Audit Trail'},
            {id:'settings', icon:'settings', label:'Preferences'}
        ];
        document.getElementById('sidebar-nav').innerHTML = menu.map(m => `
            <button onclick="App.navigate('${m.id}')" data-id="${m.id}" class="nav-btn">
                <i data-lucide="${m.icon}" class="w-5 h-5"></i> ${m.label}
            </button>
        `).join('');
    };

    App.renderers = {
        dashboard() {
            let cost = 0, fuel = 0;
            App.state.records.forEach(r => { cost += Number(r.totalCost || r.cost || 0); fuel += Number(r.liters || 0); });
            return `
                <div class="grid grid-cols-4 gap-6 mb-10">
                    ${this.widget("TOTAL CASH FLOW", cost.toLocaleString() + " TK", "text-emerald-500", "dollar-sign")}
                    ${this.widget("FUEL DISPATCHED", fuel.toFixed(1) + " L", "text-indigo-500", "fuel")}
                    ${this.widget("DATA ENTRIES", App.state.records.length, "text-amber-500", "database")}
                    ${this.widget("ACTIVE NODES", App.state.users.length, "text-blue-500", "users")}
                </div>
                <div class="grid grid-cols-3 gap-8">
                    <div class="col-span-2 card p-10 h-[450px]"><canvas id="mainChart"></canvas></div>
                    <div class="card p-10 bg-indigo-600 text-white relative overflow-hidden flex flex-col justify-between">
                        <i data-lucide="zap" class="absolute -right-10 -top-10 w-64 h-64 opacity-10"></i>
                        <div><h4 class="text-xs font-black uppercase tracking-[4px] opacity-60">System Security</h4><h2 class="text-5xl font-black italic italic italic mt-4">SECURED</h2></div>
                        <p class="text-sm font-bold opacity-80 uppercase tracking-widest leading-loose">Firebase encryption active. No unauthorized sessions detected in the last 24 hours.</p>
                    </div>
                </div>
            `;
        },

        widget(l, v, c, i) {
            return `<div class="card p-8 group hover:border-indigo-500/50 transition-all"><div class="flex justify-between items-start mb-6"><div class="p-3 bg-white/5 rounded-2xl group-hover:bg-indigo-500/10 transition-colors"><i data-lucide="${i}" class="w-5 h-5 ${c}"></i></div><span class="text-[9px] font-black text-emerald-500 bg-emerald-500/5 px-2 py-1 rounded-lg">LIVE</span></div><p class="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-1">${l}</p><h3 class="text-4xl font-black italic tracking-tighter italic">${v}</h3></div>`;
        },

        users() {
            const rows = App.state.users.map(u => `
                <tr class="hover:bg-white/5 transition">
                    <td><div class="flex items-center gap-4"><div class="w-10 h-10 rounded-xl bg-indigo-500/10 flex items-center justify-center font-black text-indigo-500">${u.name?.[0] || 'U'}</div>
                        <div><p class="font-black text-sm">${u.name || 'Anonymous'}</p><p class="text-[10px] font-bold text-slate-500">${u.email}</p></div></div></td>
                    <td><span class="px-4 py-1.5 rounded-full text-[10px] font-black uppercase ${u.status==='blocked'?'bg-red-500/10 text-red-500':'bg-emerald-500/10 text-emerald-500'}">${u.status || 'Active'}</span></td>
                    <td><p class="text-xs font-bold text-slate-400 italic">${u.bikeName || 'N/A'}</p></td>
                    <td class="text-right">
                        <button onclick="App.viewUser('${u.id}')" class="px-4 py-2 rounded-xl bg-white/5 text-[10px] font-black uppercase hover:bg-white/10 mr-2">Detail</button>
                        <button onclick="App.toggleBlock('${u.id}', '${u.status}')" class="px-4 py-2 rounded-xl bg-red-500/10 text-red-500 text-[10px] font-black uppercase hover:bg-red-500/20">Block</button>
                    </td>
                </tr>
            `).join('');
            return `<div class="card overflow-hidden"><table class="nexus-table"><thead><tr><th>User Context</th><th>System Status</th><th>Linked Unit</th><th class="text-right">Command</th></tr></thead><tbody>${rows}</tbody></table></div>`;
        },

        records() {
            const rows = App.state.records.slice(0, 50).map(r => `
                <tr class="hover:bg-white/5 transition">
                    <td><p class="font-black text-sm italic uppercase">${r.category || 'Expense'}</p><p class="text-[10px] font-bold text-slate-500">${r.userName}</p></td>
                    <td><p class="font-black italic text-indigo-500 text-lg">${r.totalCost || r.cost || 0} TK</p></td>
                    <td><p class="text-[10px] font-black text-slate-400 italic">${new Date(r.createdAt?.seconds*1000).toLocaleString()}</p></td>
                    <td class="text-right"><button onclick="App.smartPurge('${r.userId}', '${r.id}')" class="text-orange-500 text-[10px] font-black uppercase hover:underline">Smart Purge</button></td>
                </tr>
            `).join('');
            return `<div class="card overflow-hidden"><table class="nexus-table"><thead><tr><th>Identity</th><th>Impact</th><th>Temporal Data</th><th class="text-right">Action</th></tr></thead><tbody>${rows}</tbody></table></div>`;
        },

        appcontrol() {
            const flags = App.state.config;
            return `
                <div class="grid grid-cols-2 gap-8">
                    <div class="card p-10"><h3 class="text-2xl font-black italic italic italic mb-8">GLOBAL KILL-SWITCHES</h3>
                        <div class="space-y-4">
                            ${this.toggleRow("Maintenance Mode", "isMaintenance", flags.isMaintenance)}
                            ${this.toggleRow("Restrict Registration", "restrictReg", flags.restrictReg)}
                            ${this.toggleRow("Force App Update", "forceUpdate", flags.forceUpdate)}
                        </div>
                    </div>
                    <div class="card p-10"><h3 class="text-2xl font-black italic italic italic mb-8">SYSTEM BROADCAST</h3>
                        <textarea id="broadcast-msg" class="w-full h-32 bg-white/5 border border-white/10 rounded-3xl p-6 outline-none text-sm font-bold" placeholder="Input alert message..."></textarea>
                        <button onclick="App.sendBroadcast()" class="mt-6 w-full py-4 bg-indigo-600 text-white font-black rounded-2xl hover:bg-indigo-700 transition">PUSH TO ALL NODES</button>
                    </div>
                </div>
            `;
        },

        toggleRow(l, k, v) {
            return `<div class="flex justify-between items-center p-6 bg-white/5 rounded-[24px]"><p class="font-black text-sm uppercase">${l}</p>
                <input type="checkbox" onchange="App.updateFlag('${k}', this.checked)" class="w-12 h-6 accent-indigo-500" ${v?'checked':''}></div>`;
        },

        analytics() { return `<div class="grid grid-cols-2 gap-8"><div class="card p-10 h-96"><canvas id="chartA"></canvas></div><div class="card p-10 h-96"><canvas id="chartB"></canvas></div></div>`; },
        reports() { return `<div class="card p-20 text-center"><i data-lucide="file-text" class="w-20 h-20 mx-auto opacity-20 mb-6"></i><h2 class="text-3xl font-black italic italic">REPORT ENGINE READY</h2><p class="mt-4 opacity-50 font-bold uppercase tracking-widest">Select time range to generate master Excel/PDF reports.</p></div>`; },
        notifications() { return `<div class="card p-10"><h3 class="text-2xl font-black italic mb-8">SENT BROADCASTS</h3><div id="notif-list"></div></div>`; },
        admins() { return `<div class="card p-10"><h3 class="text-2xl font-black italic mb-8">CORE ADMINS</h3><div class="grid grid-cols-3 gap-6">${App.state.authorizedAdmins.map(a=>`<div class="p-6 bg-white/5 rounded-3xl font-bold text-xs">${a}</div>`).join('')}</div></div>`; },
        logs() { 
            const rows = App.state.logs.map(l => `<tr><td class="p-4 text-xs font-bold uppercase">${l.admin}</td><td class="p-4 text-xs">${l.action}</td><td class="p-4 text-[10px] opacity-50">${new Date(l.timestamp?.seconds*1000).toLocaleString()}</td></tr>`).join('');
            return `<div class="card overflow-hidden"><table class="w-full text-left nexus-table"><tbody>${rows}</tbody></table></div>`;
        },
        settings() { return `<div class="card p-10"><h2 class="text-2xl font-black italic italic italic">OS PREFERENCES</h2><p class="mt-6 opacity-40 font-bold uppercase tracking-[4px]">Nexus Intelligence v4.0.2 Stable Build</p></div>`; }
    };

    // ðŸŸ¢ MODULE LOGIC
    App.updateFlag = async (k, v) => { await db.collection('remote_config').doc('flags').update({[k]: v}); };
    App.toggleBlock = async (id, s) => { await db.collection('users').doc(id).update({status: s==='blocked'?'active':'blocked'}); };
    
    App.smartPurge = async (uid, rid) => {
        if(!confirm("Smart Purge will remove the record from user's app but keep it in Master Logs. Proceed?")) return;
        const batch = db.batch();
        batch.delete(db.collection('users').doc(uid).collection('records').doc(rid));
        batch.set(db.collection('audit_logs').doc(), {admin: auth.currentUser.email, action: "PURGE_RECORD", targetUID: uid, timestamp: firebase.firestore.FieldValue.serverTimestamp()});
        await batch.commit();
    };

    App.loadDashChart = () => {
        const ctx = document.getElementById('mainChart')?.getContext('2d');
        if(!ctx) return;
        new Chart(ctx, { type: 'line', data: { labels: ['M','T','W','T','F','S','S'], datasets: [{ data: [65, 59, 80, 81, 56, 55, 40], borderColor: '#6366f1', borderWidth: 4, tension: 0.4, fill: true, backgroundColor: 'rgba(99, 102, 241, 0.05)' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { display: false }, x: { grid: { display: false } } } } });
    };

    App.loadAnalyticsCharts = () => { /* Chart.js logic for analytics tab */ };

    App.init();
</script>
</body>
</html>